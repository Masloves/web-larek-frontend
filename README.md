# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

### Продукт

```typescript
export interface IProduct {
	id: string;
	title: string;
	category: string;
	description: string;
	image: string;
	price: number;
}
```
### Каталог продуктов
```typescript
export interface IProductsCatalog {
    items: IProduct[];
}
```
### Данные покупателя вводимые в форму заказа
```typescript
export interface IOrderForm {
    payment: string;
    address: string;
    email: string;
    phone: string;
}
```
### Данные о продуктах в заказе
```typescript
export interface IOrder extends IOrderForm {
    items: string[];
    total: number;
}
```
### Ответ API после оформления заказа
```typescript
export interface IOrderAnswer {
    id: string;
    total: number;
}
```
### Данные в форме заказа: 1. Выбор способа оплаты и адреса
```typescript
export type TPaymentForm = Pick<IOrder, 'payment' | 'address'>;
```
### Данные в форме заказа: 2. Контактные данные
```typescript
export type TContactsForm = Pick<IOrder, 'email' | 'phone'>;
```
### Данные для валидации формы заказа
```typescript
export type TForm = TPaymentForm & TContactsForm;
```
### Валидация формы заказа
```typescript
export type FormErrors = Partial<Record<keyof TForm, string>>;
```

### Категории продуктов
```typescript
export type ProductCategory = 'софт-скил' | 'другое' | 'дополнительное' | 'кнопка' | 'хард-скил';
```


## Архитектура приложения

Для реализации приложения выбран паттерн **`MVP`**. В нём приложение делится на три компонента:

- `Model` (Модель) работает с данными, проводит вычисления и руководит всеми бизнес-процессами.
- `View` (Вид или представление) показывает пользователю интерфейс и данные из модели.
- `Presenter` (Представитель) служит прослойкой между моделью и видом.


### Базовый код
---
#### Класс `Api`
---

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс `EventEmitter`
---

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   


### Слой данных (`Model`)
---

#### Класс `ProductsData`
---

Класс `ProductsData` содержит состояние всего приложения и управляет им. Класс управляет каталогом товаров, корзиной покупок и процессом оформления заказа.

Класс наследуется от базового класса `Model` с указанием типа состояния `IProductsData`.

Конструктор принимает начальные данные состояния приложения и экземпляр системы событий.

Примечание: В реализации класса `ProductsData` отсутствует явный конструктор, поэтому он использует конструктор родительского класса `Model`, который требует данные и события.

#### Свойства класса

- `catalog: IProduct[]` - массив товаров
- `preview: string | null` - идентификатор карточки для просмотра
- `order: IOrder` - заказ
- `formErrors: FormErrors` - ошибки при валидации

#### Методы

- `setProducts(items: IProduct[]): void` - устанавливает объект с карточками
- `getProduct(id: string): IProduct` - возвращает объект товара по его id
- `addToBasket(id: string): void` - добавляет товар в корзину
- `deleteFromBasket(id: string): void` - удаляет товар из корзины
- `inBasket(id: string): boolean` - проверяет есть ли в корзине товар по его идентификатору
- `getBasketProductsCount(): number` - возвращает количество товаров в корзине
- `getTotal(): number` - возвращает сумму стоимости товаров в корзине
- `clearBasket(): void` - очищает корзину
- `setOrderField(field: keyof TPaymentForm, value: string): void` - устанавливает данные в поля ввода формы способа оплаты и адреса
- `validateOrder(): void` - валидация полей формы способа оплаты и адреса (метод оплаты и адрес)
- `setContactsField(field: keyof TContactsForm, value: string): void` - устанавливает данные в поля ввода формы контактов
- `validateContacts(): void` - валидация полей формы контактов (email и телефон)
- `setPreview(item: IProduct): void` - устанавливает карточку для показа


### Слой представления (`View`)
---

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс `Modal`
---
Класс `Modal` представляет собой компонент для управления основным отображением страницы приложения. Наследуется от базового класса `Component` и реализует интерфейс `IModalData`.
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатель события, для закрытия модального окна по клику на кнопку-крестик для закрытия попапа. 

#### Свойства класса

- `_content` - контейнер для содержания модального окна
- `_closeButton` - кнопка закрытия окна

#### Сеттеры

- `content` - устанавливает содержимое модального окна

#### Методы

- `open` - открывает модальное окно. Генерирует событие `modal:open`, по которому происходит блокировка скроллинга страницы.
- `close` - очищает от контента и закрывает модальное окно. Генерирует событие `modal:close`, по которому происходит разблокировка скроллинга страницы.
- `render` - возвращает корневой DOM-элемент. Переопредленный метод базового класса, т.к. кроме возврата корневого элемента надо еще открыть модальное окно методом `open`.


#### Класс `Form<T>`
---

Абстрактный класс `Form<T>` предоставляет базовую функциональность для работы с формами в приложении. Наследуется от класса `Component` и реализует общую логику для:

- Обработки пользовательского ввода
- Валидации формы
- Отображения ошибок
- Отправки данных

Выделение базовой функциональности работы с формами в абстракный класс обусловлено наличием общей для всех форм и их полей функцилнальностью:

- использование джененрик типа позволяет типизировать все поля формы, что обеспечивает безовасность при работе с данными формы,
- интеграция с брокером событий, что позволяет отделить логику валидации от представления
- метод `render` принимает как данные формы, так и состояние валидации, что позволяет единообразно обновлять все аспекты формы
- подписка на события input и submit настраивается автоматически. Не требует дополнительной настройки в наследующих классах
- интеграция с базовым `Component` наследует базовую функциональность компонента и добавляет специфичное для форм поведение

#### Свойства

- `_submit` - кнопка отправки формы
- `_errors` - контейнер для отображения ошибок

#### Сеттеры

- `valid` - проверяет выбран ли способ оплаты
- `errors` - устанавливает текст ошибок формы


#### Методы

- `onFieldChange` - обрабатывает изменения в полях формы и генерирует соответствующие события.

- `render` - обновляет состояние формы и возвращает DOM-элемент.

#### Слушатели событий

- input - Отслеживает изменения в полях ввода, для каждого изменения генерирует событие через `onFieldChange`

- submit - Перехватывает стандартное поведение формы, генерирует событие `${this.container.name}:submit`


#### Класс `Page`
---

Класс `Page` представляет компонент для управления основным содержимым главной страницы приложения. Наследуется от базового класса `Component` и реализует интерфейс `IPage`.

#### Свойства класса

- `_counter` - элемент для отображения количества товаров в корзине
- `_catalog` - контейнер для карточек товаров
- `_wrapper` - используется для блокировки прокрутки страницы при открытии модального окна
- `_basket` - иконка (кнопка) корзины

#### Сеттеры

- `counter` - устанавливает значение счетчика товаров в корзине
- `catalog` - устанавливает содержимое каталога
- `locked` - блокирует/разблокирует прокрутку страницы

#### Слушатели событий

При клике на иконку (кнопку) корзины инициализируется событие `basket:open`, открывающее модальное окно с содержимым корзины.


#### Класс `Card`
---

Класс `Card` реализует интерфейс `ICard` и отвечает за отображение карточки товара, задавая в карточке данные категории товара, названия товара, изображения, цены товара.\
Класс используется для отображения карточек:

1. В коллекции на главной странице
2. В модальном окне просмотра карточки
3. В корзине

Он наследуется от базового класса `Component`.

#### Свойства класса

Все свойства являются DOM элементами

- `_title` - заголовок карточки
- `_image` - изображение товара (опционально)
- `_description` - описание товара (опционально)
- `_button` - кнопка довавления в корзину / удаления из корзины (опционально)
- `_category` - категория товара (опционально)
- `_price` - цена товара
- `_itemIndex` - положение в списке внутри корзины (опционально)

#### Сеттеры

Сеттеры устанавливают:

- `id` - data-атрибут идентификатора карточки
- `title` - текст заголовка карточки
- `image` - изображение товара и alt-текст с текстом заголовка
- `description` - текст описания товара
- `category` - категорию товара и соответствующие ей css-свойства
- `price` - цену товара с форматированием. Если цена не установлена, то выводится сообщение "Бесценно". Текст берется из настроек приложения `settings.card.priceless`
- `index` - порядковый номер товара в корзине

#### Методы

- `changeButton` - обновляет состояние кнопки "Купить" и ее текст в зависимости от цены и наличия этого товара в корзине. Тексты берутся из настроек `settings.cardButtonValues`

#### Обработчики событий

Если при создании карточки был передан обработчик `actions.onClick`, то добавляется:

1. На кнопку, если она есть в контейнере
2. Если нет, на сам контейнер карточки


#### Класс `Basket`
---
Представляет компонент корзины с товарами. Наследуется от базового класса `Component`. Реализует функционал для отображения списка товара и общей суммы заказа.

#### Свойства класса

- `_list` - контейнер для списка товаров
- `_total` - элемент для отображения общей суммы
- `_button` - кнопка оформления заказа

#### Сеттеры

- `items` - устанавливает список товаров в корзине. Если товаров нет (пустой массив), показывается надпись "Корзина пуста". Текст берется из настроек приложения `settings.basket.null`
- `total` - устанавливает общую сумму заказа

#### Обработчики событий

При клике на кнопку оформления заказа генерируется событие `order:open`. Событие открытия модального окна с первой формой оформления заказа.


#### Класс `Order`
---

Класс `Order` наследуется от базового класса `Form` и реализует логику для первого шага оформления заказа - выбора способа оплаты и ввода адреса доставки.

#### Свойства класса

- `_buttonOnline` - кнопка выбора оплаты онлайн
- `_buttonCash` - кнопка выбора оплаты наличными

Для доступа к полям формы используется `elements.namedItem()`.

#### Сеттеры

- `payment` - устанавливает выбор способа оплаты
- `address` - устанавливает значение поля ввода адреса

#### Обработчики событий и слушатели

При клике на кнопку оплаты `"Онлайн"`:

1. Активирует визуальное состояние кнопки
2. Отключает состояние у кнопки "При получении"
3. Генерирует событие изменения поля `payment`

Клик на кнопку оплаты `"При получении"`:

1. Активирует визуальное состояние кнопки
2. Отключает состояние у кнопки "Онлайн"
3. Генерирует событие изменения поля `payment`


#### Класс `Contacts`
---

Класс `Contacts` наследуется от базового класса `Form` и реализует логику для второго шага оформления заказа - ввода email и номера телефона.


#### Свойства класса

Отсутствуют.

Для доступа к полям формы используется `elements.namedItem()`.

#### Сеттеры

- `email` - устанавливает значение поля `Email`
- `phone` - устанавливает значение поля `"Телефон"` с номером телефона


#### Класс `Success`
---

Класс `Success` наследуется от базового класса `Component`. Представляет компонент отображения успешного завершения заказа и реализует интерфейс `IPage`.

#### Свойства класса

- `_close` - кнопка закрытия модального окна 
- `_total` - элемент для отображения итоговой суммы

#### Сеттеры

- `total` - устанавливает итоговую сумму заказа

#### Обработчики событий

**(Опционально)** Обработчик `actions.onClick`, то он вызывает слушатель события закрытия модального окна при клике на кнопку `"За новыми покупками!"` и закрывает модальное окно.


### Слой коммуникации (`API`)
---

#### Класс `WebLarekAPI`
---

Класс `WebLarekApi` реализует взаимодействие с серверной частью приложения. Наследуется от базового класса `Api` и реализует интерфейс `IWebLarekApi`.

#### Методы

- `getProducts` отправляет запрос данных продуктов с сервера, возвращает массив продуктов
- `sendOrder()` отправляет данные заказа на сервер, возвращает ответ сервера об успешно оформленном заказе с суммой заказа


### Презентер (`Presenter`)
---

 Presenter размещен в основном скрипте приложения `src/index.ts` и выступает в роли посредника между `Model` (данные) и `View` (отображение), обрабатывая пользовательские действия и обновляя состояние приложения.

#### Основные компоненты:

1. `EventEmitter` - брокер событий
2. `Model` (AppData) - хранит состояние приложения (каталог, корзина, заказ)
3. `View` компоненты (`Page`, `Modal`, `Basket`, `Order` и др.) - отвечают за отображение
4. `API` (WebLarekApi) - взаимодействие с сервером
5. `Presenter` (данный файл) - связующее звено, бизнес-логика


## Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События, возникающие при первоначальной загрузке страницы*
- `products:changed` - получение каталога товаров
*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `card:select` - выбор карточки товара для отображения в модальном окне
- `preview:changed` - открывает модальное окно просмотра карточки товара
- `basket:changed` - реакция на клик "Купить" или "Удалить из корзины" в карточке товара
- `basket:open` - открывает модальное окно корзины
- `basket:delete` - реакция на клик на иконку удаления товара в корзине
- `order:open` - реакция на клик "Оформить" в корзине
- `/^order\..*:change/` - реакция на клики по кнопкам "Онлайн", "При получении" и на ввод текста в поле "Адрес"
- `orderFormErrors:change` - реакция на изменение состояния валидации формы выбора оплаты и ввода адреса доставки
- `order:submit` - реакция на кнопку "Далее" в модальном окне первого шага оформления заказа
- `/^contacts\..*:change/` - реакция на ввод текста в поля "Телефон" и "Email"
- `contactsFormErrors:change` - реакция на изменение состояния валидации формы ввода номера телефона и email
- `contacts:submit` - реакция на кнопку "Оплатить" в модальном окне второго шага оформления заказа
- `modal:open` - блокировка прокрутки страницы если открыто модальное окно
- `modal:close` - разблокировка прокрутки страницы после закрытия модального окна
